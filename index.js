// ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù…Ø«Ù„ getFileDownloadUrl Ùˆ extractFileId ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...

// =======================================================
// 3. FILE UPLOAD HANDLER (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù…Ø­ØµÙ†Ø© Ø¶Ø¯ ÙØ´Ù„ getFile)
// =======================================================
async function handleUpload(req) {
    // ğŸ›‘ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
        if (BOTTOKEN === "BOTTOKEN_REQUIRED" || !CHATID || CHATID === "CHATID_REQUIRED") {
                return new Response(
                            JSON.stringify({ success: false, message: "Server Error: BOTTOKEN or CHATID is not configured." }),
                                        { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                );
                                                    }

                                                        try {
                                                                const formData = await req.formData();
                                                                        const file = formData.get('file');

                                                                                if (!file || typeof file === 'string') {
                                                                                            return new Response(
                                                                                                            JSON.stringify({ success: false, message: "No file part in the request (Field name must be 'file')." }),
                                                                                                                            { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                        );
                                                                                                                                                }
                                                                                                                                                        
                                                                                                                                                                const mimeType = file.type || 'application/octet-stream';
                                                                                                                                                                        const fileName = file.name || 'unknown_filename'; 
                                                                                                                                                                                
                                                                                                                                                                                        // ğŸ›‘ Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ API Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (Ù„Ù€ sendPhoto/sendVideo/sendDocument)
                                                                                                                                                                                                let targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendDocument`;
                                                                                                                                                                                                        let attachmentKeyName = 'document';
                                                                                                                                                                                                                const MB = 1024 * 1024;
                                                                                                                                                                                                                        
                                                                                                                                                                                                                                if (mimeType.startsWith('image/') && file.size < (IMAGE_LIMIT_MB * MB)) { 
                                                                                                                                                                                                                                            attachmentKeyName = 'photo';
                                                                                                                                                                                                                                                        targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendPhoto`;
                                                                                                                                                                                                                                                                } else if (mimeType.startsWith('video/') && file.size < (VIDEO_LIMIT_MB * MB)) { 
                                                                                                                                                                                                                                                                            attachmentKeyName = 'video';
                                                                                                                                                                                                                                                                                        targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendVideo`;
                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                        const telegramFormData = new FormData();
                                                                                                                                                                                                                                                                                                                telegramFormData.append('chat_id', CHATID);
                                                                                                                                                                                                                                                                                                                        telegramFormData.append('caption', `Uploaded via Web App: ${fileName}`);
                                                                                                                                                                                                                                                                                                                                telegramFormData.append(attachmentKeyName, file, fileName); 

                                                                                                                                                                                                                                                                                                                                        // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Telegram
                                                                                                                                                                                                                                                                                                                                                const telegramResponse = await fetch(targetUploadUrl, { method: 'POST', body: telegramFormData });

                                                                                                                                                                                                                                                                                                                                                        if (!telegramResponse.ok) {
                                                                                                                                                                                                                                                                                                                                                                    const errorText = await telegramResponse.text();
                                                                                                                                                                                                                                                                                                                                                                                throw new Error(`Telegram API Upload Failed (Status ${telegramResponse.status}): ${errorText}`);
                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                const data = await telegramResponse.json();

                                                                                                                                                                                                                                                                                                                                                                                                        if (data.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                    const result = data.result;
                                                                                                                                                                                                                                                                                                                                                                                                                                const fileId = extractFileId(result);
                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!fileId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        throw new Error(`Telegram succeeded, but file ID extraction failed.`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // ğŸ›‘ 2. Ø·Ù„Ø¨ file_path Ùˆ download_url Ø§Ù„ØµØ­ÙŠØ­ - Ù†Ø³ØªØ®Ø¯Ù… try/catch Ù…Ø­Ù„ÙŠ Ù‡Ù†Ø§
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let filePath = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    let downloadUrl = null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let note = 'success';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const linkData = await getFileDownloadUrl(fileId, BOTTOKEN);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        filePath = linkData.filePath;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        downloadUrl = linkData.downloadUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        note = linkData.note || 'success';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // ğŸ›‘ Ù…Ø¹Ø§Ù„Ø¬Ø© ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø· Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø© (Ø§Ù„Ø®Ø·Ø£ 400)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.warn(`Failed to get download URL for file ID ${fileId}: ${e.message}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Ù†Ø¶Ø¨Ø· Ø§Ù„Ù‚ÙŠÙ… Ø¹Ù„Ù‰ null ÙˆÙ†Ø¶ÙŠÙ Ù…Ù„Ø§Ø­Ø¸Ø©ØŒ Ù„ÙƒÙ† Ù†ÙØ³Ù’ØªÙÙ…ÙØ± (SUCCESS = 200)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    note = 'file_path_unavailable_too_large'; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ğŸ›‘ 3. Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù†Ø¬Ø§Ø­ (HTTP 200) Ù„Ø­ÙØ¸ Ø§Ù„Ù€ file_id ÙÙŠ Firestore
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            file_id: fileId, // âœ… Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø£Ù‡Ù…
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file_path: filePath, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    download_url: downloadUrl, // âœ… Ù‚Ø¯ ÙŠÙƒÙˆÙ† null Ù„Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ÙƒØ¨ÙŠØ±Ø©
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        filename: fileName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            upload_method: attachmentKeyName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                note: note
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                throw new Error(`Telegram API Error: ${data.description || 'Unknown error'}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.error("Server Error in handleUpload:", e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // Ù†ÙØ±Ø¬Ø¹ Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø§Ù„ØªÙŠ ØªØ³Ø¨Ø¨Øª ÙÙŠ Ø§Ù„Ø®Ø±ÙˆØ¬
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                JSON.stringify({ success: false, message: e.message || "An unexpected server error occurred." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // ... (Ø¨Ù‚ÙŠØ© Ø§Ù„Ø±Ø§ÙˆØªØ± ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ) ...