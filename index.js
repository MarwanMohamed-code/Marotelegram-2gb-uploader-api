// =======================================================
// 1. CONFIGURATION & SECRETS
// =======================================================
const BOTTOKEN = Deno.env.get("BOTTOKEN") || "BOTTOKEN_REQUIRED";
const CHATID = Deno.env.get("CHATID") || "CHATID_REQUIRED";

// üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 5) ÿ•ÿπÿØÿßÿØÿßÿ™ ÿ≠ÿØŸàÿØ ÿßŸÑÿ≠ÿ¨ŸÖ ŸÇÿßÿ®ŸÑÿ© ŸÑŸÑÿ™ÿπÿØŸäŸÑ ÿπÿ®ÿ± ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ®Ÿäÿ¶ÿ©
const IMAGE_LIMIT_MB = parseFloat(Deno.env.get("IMAGE_LIMIT_MB") || 20);
const VIDEO_LIMIT_MB = parseFloat(Deno.env.get("VIDEO_LIMIT_MB") || 50);
const MB = 1024 * 1024;
const MAX_RETRIES = 3;

// üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 6) ÿ™ÿ≠ÿ≥ŸäŸÜ CORS
const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type, Authorization',
            };

            // =======================================================
            // 2. HELPER FUNCTIONS
            // =======================================================

            /**
             * üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 4) Ÿàÿ∏ŸäŸÅÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ© ŸÑÿ¨ŸÑÿ® file_path Ÿàÿ®ŸÜÿßÿ° ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
              * @param {string} fileId
               * @param {string} botToken
                * @returns {Promise<{filePath: string, downloadUrl: string} | {filePath: null, downloadUrl: null, note: string}>}
                 */
                 async function getFileDownloadUrl(fileId, botToken) {
                     const getFileUrl = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;

                         // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 4 Ÿà 8) ÿ•ÿ∂ÿßŸÅÿ© Retry Mechanism ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°
                             for (let i = 0; i < MAX_RETRIES; i++) {
                                     try {
                                                 const getFileResponse = await fetch(getFileUrl);
                                                             
                                                                         if (!getFileResponse.ok) {
                                                                                         const errorText = await getFileResponse.text();
                                                                                                         // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿÆÿ∑ÿ£ 400ÿå ŸÜÿ±ÿ¨ÿπŸá ŸÉÿ≠ÿßŸÑÿ© ÿÆÿßÿµÿ© ÿØŸàŸÜ ÿ•ÿπÿßÿØÿ© ŸÖÿ≠ÿßŸàŸÑÿ©
                                                                                                                         if (getFileResponse.status === 400 && errorText.includes("file is too big")) {
                                                                                                                                             console.warn(`getFile failed for large fileId ${fileId}: ${errorText}`);
                                                                                                                                                                 // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 4) ÿ±ÿ≥ÿßŸÑÿ© ÿµÿØŸäŸÇÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
                                                                                                                                                                                     return { filePath: null, downloadUrl: null, note: 'file_path_unavailable_too_large' };
                                                                                                                                                                                                     }
                                                                                                                                                                                                                     throw new Error(`Telegram API getFile Failed: ${getFileResponse.status} - ${errorText}`);
                                                                                                                                                                                                                                 }

                                                                                                                                                                                                                                             const fileData = await getFileResponse.json();

                                                                                                                                                                                                                                                         if (fileData.ok && fileData.result.file_path) {
                                                                                                                                                                                                                                                                         const filePath = fileData.result.file_path;
                                                                                                                                                                                                                                                                                         // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 3) Ÿäÿ¨ÿ® ÿ£ŸÜ ŸÑÿß ŸÜÿ±ÿ≥ŸÑ ÿßŸÑÿ™ŸàŸÉŸÜ ŸÅŸä ÿßŸÑÿ±ÿßÿ®ÿ∑ ŸÑŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ©
                                                                                                                                                                                                                                                                                                         // ÿ≥ŸÜÿ≥ÿ™ÿÆÿØŸÖ download_url ŸÑŸÉŸÜŸÜÿß ÿ≥ŸÜŸÅÿ™ÿ±ÿ∂ ÿ£ŸÜ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ© ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ•ŸÑŸâ ÿ®ÿ±ŸàŸÉÿ≥Ÿä ÿ£Ÿà ÿ™ŸàŸÉŸÜ ŸÖÿÆÿ™ŸÑŸÅ
                                                                                                                                                                                                                                                                                                                         // ŸÑŸÉŸÜ ŸÑÿ™ŸÑÿ®Ÿäÿ© ÿ∑ŸÑÿ® ÿßŸÑŸÜŸÇÿ∑ÿ© 5ÿå ÿ≥ŸÜÿ±ÿ≥ŸÑ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑÿµÿ≠Ÿäÿ≠ (ŸÑŸÑÿπÿ±ÿ∂ ŸàÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ)
                                                                                                                                                                                                                                                                                                                                         const downloadUrl = `https://api.telegram.org/file/bot${botToken}/${filePath}`;
                                                                                                                                                                                                                                                                                                                                                         return { filePath, downloadUrl, note: 'success' };
                                                                                                                                                                                                                                                                                                                                                                     } else {
                                                                                                                                                                                                                                                                                                                                                                                     throw new Error(`Telegram API getFile Error: ${fileData.description || 'Unknown error getting file path'}`);
                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                         } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                     console.error(`Attempt ${i + 1} failed for getFile:`, e.message);
                                                                                                                                                                                                                                                                                                                                                                                                                                 if (i === MAX_RETRIES - 1) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                 // ŸÅÿ¥ŸÑ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™
                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return { downloadUrl: null, filePath: null, note: `file_path_unavailable_after_${MAX_RETRIES}_retries` };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1))); // ÿßŸÜÿ™ÿ∏ÿßÿ± ŸÇÿ®ŸÑ ÿ•ÿπÿßÿØÿ© ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ©
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     /**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      * ÿØÿßŸÑÿ© ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ file_id (ÿ™ŸÖ ÿßŸÑÿßÿ≠ÿ™ŸÅÿßÿ∏ ÿ®ÿ≥ŸÑŸàŸÉ ÿßŸÑŸÜŸÇÿ∑ÿ© 7 ÿßŸÑÿµÿ≠Ÿäÿ≠)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       function extractFileId(result) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (!result) return null;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (result.document && result.document.file_id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return result.document.file_id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (result.video && result.video.file_id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       return result.video.file_id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (result.photo && Array.isArray(result.photo) && result.photo.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 7) ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿµÿ≠Ÿäÿ≠ÿ©
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               const largestPhoto = result.photo[result.photo.length - 1]; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if (largestPhoto.file_id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return largestPhoto.file_id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (result.audio && result.audio.file_id) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return result.audio.file_id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return null;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // 3. FILE UPLOAD HANDLER
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    async function handleUpload(req) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 1) ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿ™ŸàŸÉŸÜ ŸàÿßŸÑŸÄ CHATID ÿπŸÜÿØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ¥ÿ∫ŸäŸÑ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (BOTTOKEN === "BOTTOKEN_REQUIRED") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                JSON.stringify({ success: false, message: "Server Error: BOTTOKEN is not configured." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (!CHATID || CHATID === "CHATID_REQUIRED") {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                JSON.stringify({ success: false, message: "Server Error: CHATID is not configured." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 10) ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿßŸÑŸÖÿµÿßÿØŸÇÿ©/ÿßŸÑÿ™ÿ≠ŸÇŸÇ ÿßŸÑÿ£ŸÖŸÜŸä Ÿäÿ¨ÿ® ÿ£ŸÜ Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ™Ÿá ŸáŸÜÿß ŸÇÿ®ŸÑ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑŸÖŸÑŸÅ

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const formData = await req.formData();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const file = formData.get('file');

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (!file || typeof file === 'string') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    JSON.stringify({ success: false, message: "No file part in the request (Field name must be 'file')." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const mimeType = file.type || 'application/octet-stream';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 2) ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ fallback ŸÑÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const fileName = file.name || 'unknown_filename'; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 5) ÿ™ÿ≠ÿØŸäÿØ API ÿßŸÑŸÖŸÜÿßÿ≥ÿ® ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ≠ÿ¨ŸÖ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                let targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendDocument`; // Default: 2GB
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let attachmentKeyName = 'document';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (mimeType.startsWith('image/') && file.size < (IMAGE_LIMIT_MB * MB)) { 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    attachmentKeyName = 'photo';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendPhoto`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (mimeType.startsWith('video/') && file.size < (VIDEO_LIMIT_MB * MB)) { 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    attachmentKeyName = 'video';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendVideo`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const telegramFormData = new FormData();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        telegramFormData.append('chat_id', CHATID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                telegramFormData.append('caption', `Uploaded via Web App: ${fileName}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        telegramFormData.append(attachmentKeyName, file, fileName); 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // 1. ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ Telegram 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const telegramResponse = await fetch(targetUploadUrl, { method: 'POST', body: telegramFormData });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!telegramResponse.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const errorText = await telegramResponse.text();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        throw new Error(`Telegram API Upload Failed (Status ${telegramResponse.status}): ${errorText}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const data = await telegramResponse.json();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (data.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const result = data.result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const fileId = extractFileId(result);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (!fileId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                throw new Error(`Telegram succeeded, but file ID extraction failed.`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // 2. ÿ∑ŸÑÿ® file_path Ÿà download_url ÿßŸÑÿµÿ≠Ÿäÿ≠ (ŸÖÿπ ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const { filePath, downloadUrl, note } = await getFileDownloadUrl(fileId, BOTTOKEN);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 5) ÿ•ÿ±ÿ¨ÿßÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            file_id: fileId,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                file_path: filePath, // ‚úÖ ŸäŸèÿ≥ÿ™ÿÆÿØŸÖ ŸÑÿ®ŸÜÿßÿ° ÿ±Ÿàÿßÿ®ÿ∑ ÿ£ŸÉÿ´ÿ± ÿ£ŸÖÿßŸÜŸãÿß (Proxy)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    download_url: downloadUrl, // ‚úÖ ÿßŸÑÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖÿ®ÿßÿ¥ÿ± (Ÿäÿ≠ÿ™ŸàŸä ÿßŸÑÿ™ŸàŸÉŸÜ)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        filename: fileName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            upload_method: attachmentKeyName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                note: note || 'success'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                throw new Error(`Telegram API Error: ${data.description || 'Unknown error'}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    console.error("Server Error in handleUpload:", e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        JSON.stringify({ success: false, message: e.message || "An unexpected server error occurred." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // 4. MAIN ROUTER
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                Deno.serve(async (req) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 10) ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ŸáŸÜÿß ŸäŸÖŸÉŸÜ ÿ•ÿ∂ÿßŸÅÿ© ŸÅÿ≠ÿµ ÿßŸÑŸÖÿµÿßÿØŸÇÿ© (Auth check) ŸÑÿ¨ŸÖŸäÿπ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const url = new URL(req.url);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const pathname = url.pathname;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (req.method === 'OPTIONS') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return new Response(null, { status: 204, headers: corsHeaders });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (pathname.startsWith('/upload_file') && req.method === 'POST') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return handleUpload(req);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // üõë (ÿßŸÑŸÜŸÇÿ∑ÿ© 9) ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ•ÿ∞ÿß ÿ£ÿ±ÿØÿ™ ÿØÿπŸÖ ŸÖÿ≥ÿßÿ± ÿßŸÑÿ®ÿ±ŸàŸÉÿ≥Ÿä:
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // if (pathname.startsWith('/download_proxy')) { 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            //    // ŸáŸÜÿß Ÿäÿ™ŸÖ ÿ®ŸÜÿßÿ° ÿØÿßŸÑÿ© ÿßŸÑÿ®ÿ±ŸàŸÉÿ≥Ÿä ŸÑÿ¨ŸÑÿ® ÿßŸÑŸÖŸÑŸÅ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ file_id ÿ®ÿØŸàŸÜ ŸÉÿ¥ŸÅ ÿßŸÑÿ™ŸàŸÉŸÜ
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                // }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            JSON.stringify({ success: false, message: 'Invalid route.' }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        });