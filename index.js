// =======================================================
// 1. TELEGRAM CONFIGURATION (ÙŠØ³ØªØ®Ø¯Ù… Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©)
// =======================================================
const BOTTOKEN = Deno.env.get("BOTTOKEN") || "BOTTOKEN_REQUIRED";
const CHATID = Deno.env.get("CHATID") || "CHATID_REQUIRED";
const TELEGRAMUPLOADURL = `https://api.telegram.org/bot${BOTTOKEN}/sendDocument`;

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type',
            };

            // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± (file_path) ÙˆØ¨Ù†Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµØ­ÙŠØ­ (ØªÙ… Ø¥Ø¨Ù‚Ø§Ø¤Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ)
            async function getFileDownloadUrl(fileId, botToken) {
                const getFileUrl = `https://api.telegram.org/bot${botToken}/getFile?file_id=${fileId}`;
                    
                        const getFileResponse = await fetch(getFileUrl);
                            if (!getFileResponse.ok) {
                                    const errorText = await getFileResponse.text();
                                            throw new Error(`Telegram API getFile Failed: ${getFileResponse.status} - ${errorText}`);
                                                }

                                                    const fileData = await getFileResponse.json();

                                                        if (fileData.ok && fileData.result.file_path) {
                                                                const filePath = fileData.result.file_path;
                                                                        return `https://api.telegram.org/file/bot${botToken}/${filePath}`;
                                                                            } else {
                                                                                    throw new Error(`Telegram API getFile Error: ${fileData.description || 'Unknown error getting file path'}`);
                                                                                        }
                                                                                        }

                                                                                        // =======================================================
                                                                                        // 2. FILE UPLOAD HANDLER (POST /upload_file)
                                                                                        // =======================================================
                                                                                        async function handleUpload(req) {
                                                                                            if (BOTTOKEN === "BOTTOKEN_REQUIRED") {
                                                                                                    return new Response(
                                                                                                                JSON.stringify({ success: false, message: "Server Error: BOTTOKEN is not configured." }),
                                                                                                                            { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                    );
                                                                                                                                        }

                                                                                                                                            try {
                                                                                                                                                    const formData = await req.formData();
                                                                                                                                                            const file = formData.get('file');

                                                                                                                                                                    if (!file || typeof file === 'string') {
                                                                                                                                                                                return new Response(
                                                                                                                                                                                                JSON.stringify({ success: false, message: "No file part in the request (Field name must be 'file')." }),
                                                                                                                                                                                                                { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                            );
                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                            const telegramFormData = new FormData();
                                                                                                                                                                                                                                                    telegramFormData.append('chat_id', CHATID);
                                                                                                                                                                                                                                                            telegramFormData.append('caption', `Uploaded via Web App: ${file.name}`);
                                                                                                                                                                                                                                                                    telegramFormData.append('document', file, file.name); 

                                                                                                                                                                                                                                                                            // 1. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Telegram 
                                                                                                                                                                                                                                                                                    const telegramResponse = await fetch(TELEGRAMUPLOADURL, { method: 'POST', body: telegramFormData });
                                                                                                                                                                                                                                                                                            if (!telegramResponse.ok) {
                                                                                                                                                                                                                                                                                                        const errorText = await telegramResponse.text();
                                                                                                                                                                                                                                                                                                                    throw new Error(`Telegram API Upload Failed: ${telegramResponse.status} - ${errorText}`);
                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                    const data = await telegramResponse.json();

                                                                                                                                                                                                                                                                                                                                            if (data.ok) {
                                                                                                                                                                                                                                                                                                                                                        const result = data.result;
                                                                                                                                                                                                                                                                                                                                                                    let fileId;

                                                                                                                                                                                                                                                                                                                                                                                // ðŸ›‘ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ø­Ø§Ø³Ù…: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† file_id ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù…Ø§ÙƒÙ† Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
                                                                                                                                                                                                                                                                                                                                                                                            if (result.document) {
                                                                                                                                                                                                                                                                                                                                                                                                            fileId = result.document.file_id; // Ù…Ù„Ù Ø¹Ø§Ù…/Ù…Ø³ØªÙ†Ø¯
                                                                                                                                                                                                                                                                                                                                                                                                                        } else if (result.video) {
                                                                                                                                                                                                                                                                                                                                                                                                                                        fileId = result.video.file_id;   // Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ
                                                                                                                                                                                                                                                                                                                                                                                                                                                    } else if (result.photo && result.photo.length > 0) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // Ù†Ø£Ø®Ø° file_id Ù„Ø£ÙƒØ¨Ø± Ù†Ø³Ø®Ø© Ù…Ù† Ø§Ù„ØµÙˆØ±Ø© (Ø¹Ø§Ø¯Ø©Ù‹ Ø§Ù„Ø£Ø®ÙŠØ±Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const largestPhoto = result.photo.pop();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    fileId = largestPhoto.file_id;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 throw new Error("Could not find file metadata (document, video, or photo) in Telegram response.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (!fileId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     throw new Error("File ID was successfully found but is empty.");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const fileName = file.name;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 // 2. Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆØ§Ù„Ù…ØµØ­Ø­ Ø§Ù„Ø°ÙŠ ÙŠØ­Ù„ Ù…Ø´ÙƒÙ„Ø© 404
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const downloadUrl = await getFileDownloadUrl(fileId, BOTTOKEN);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             file_id: fileId, 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 download_url: downloadUrl, // âœ… Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ØµØ­Ø­
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     filename: fileName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         message: `File uploaded successfully.`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         throw new Error(`Telegram API Error: ${data.description || 'Unknown error'}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             console.error("Server Error in handleUpload:", e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 JSON.stringify({ success: false, message: e.message || "An unexpected server error occurred." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // 3. MAIN ROUTER
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         Deno.serve(async (req) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             const url = new URL(req.url);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const pathname = url.pathname;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (req.method === 'OPTIONS') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return new Response(null, { status: 204, headers: corsHeaders });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     if (pathname.startsWith('/upload_file') && req.method === 'POST') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return handleUpload(req);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 JSON.stringify({ success: false, message: 'Invalid route.' }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             });