// =======================================================
// 1. TELEGRAM CONFIGURATION
// =======================================================
const BOTTOKEN = Deno.env.get("BOTTOKEN") || "BOTTOKEN_REQUIRED";
const CHATID = Deno.env.get("CHATID") || "CHATID_REQUIRED";

const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, OPTIONS',
            'Access-Control-Allow-Headers': 'Content-Type',
            };

            // =======================================================
            // 2. HELPER FUNCTIONS
            // =======================================================

            // üõë ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿØÿßŸÑÿ© getFileDownloadUrl ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ŸÑÿ£ŸÜŸáÿß ŸÉÿßŸÜÿ™ ÿ™ÿ≥ÿ®ÿ® ÿßŸÑÿÆÿ∑ÿ£ 400 ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑŸÉÿ®Ÿäÿ±ÿ©.
            // ÿ≥ŸÜÿπÿ™ŸÖÿØ ÿπŸÑŸâ ÿßŸÑŸàÿßÿ¨Ÿáÿ© ÿßŸÑÿ£ŸÖÿßŸÖŸäÿ© (Next.js) ŸÅŸä ÿ®ŸÜÿßÿ° ÿ±ÿßÿ®ÿ∑ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ file_id ŸàÿßŸÑÿ™ŸàŸÉŸÜ.

            // üõë ÿØÿßŸÑÿ© ŸÖÿ≠ÿ≥ŸëŸÜÿ©: ÿ™ÿ≥ÿ™ÿÆÿ±ÿ¨ file_id ŸÖŸÜ ÿ£Ÿä ŸÜŸàÿπ ŸÖŸÜ ÿ£ŸÜŸàÿßÿπ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© Telegram
            function extractFileId(result) {
                if (!result) return null;

                    // 1. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÖÿ≥ÿ™ŸÜÿØ ÿßŸÑÿπÿßŸÖ (Document)
                        if (result.document && result.document.file_id) {
                                return result.document.file_id;
                                    }
                                        // 2. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÅŸäÿØŸäŸà (Video)
                                            if (result.video && result.video.file_id) {
                                                    return result.video.file_id;
                                                        }
                                                            // 3. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸàÿ™Ÿäÿßÿ™ (Audio/Voice)
                                                                if (result.audio && result.audio.file_id) {
                                                                        return result.audio.file_id;
                                                                            }
                                                                                // 4. ÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑÿµŸàÿ± (Photo - array of sizes)
                                                                                    if (result.photo && Array.isArray(result.photo) && result.photo.length > 0) {
                                                                                            // ŸÜÿ£ÿÆÿ∞ file_id ŸÑÿ£ŸÉÿ®ÿ± ŸÜÿ≥ÿÆÿ© ŸÖŸÜ ÿßŸÑÿµŸàÿ±ÿ© (ÿπÿßÿØÿ©Ÿã ÿ¢ÿÆÿ± ÿπŸÜÿµÿ±)ÿå ÿ®ÿØŸàŸÜ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ pop()
                                                                                                    const largestPhoto = result.photo[result.photo.length - 1]; 
                                                                                                            if (largestPhoto.file_id) {
                                                                                                                         return largestPhoto.file_id;
                                                                                                                                 }
                                                                                                                                     }

                                                                                                                                         return null;
                                                                                                                                         }

                                                                                                                                         // =======================================================
                                                                                                                                         // 3. FILE UPLOAD HANDLER (POST /upload_file)
                                                                                                                                         // =======================================================
                                                                                                                                         async function handleUpload(req) {
                                                                                                                                             if (BOTTOKEN === "BOTTOKEN_REQUIRED") {
                                                                                                                                                     return new Response(
                                                                                                                                                                 JSON.stringify({ success: false, message: "Server Error: BOTTOKEN is not configured." }),
                                                                                                                                                                             { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                     );
                                                                                                                                                                                         }

                                                                                                                                                                                             try {
                                                                                                                                                                                                     const formData = await req.formData();
                                                                                                                                                                                                             const file = formData.get('file');

                                                                                                                                                                                                                     if (!file || typeof file === 'string') {
                                                                                                                                                                                                                                 return new Response(
                                                                                                                                                                                                                                                 JSON.stringify({ success: false, message: "No file part in the request (Field name must be 'file')." }),
                                                                                                                                                                                                                                                                 { status: 400, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                             );
                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                     const mimeType = file.type || 'application/octet-stream';
                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                     let targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendDocument`; // Default: sendDocument (up to 2GB)
                                                                                                                                                                                                                                                                                                                             let attachmentKeyName = 'document'; // Default key for the file in FormData

                                                                                                                                                                                                                                                                                                                                     // üõë ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑÿ¨ŸàŸáÿ±Ÿä: ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ API ÿßŸÑÿµÿ≠Ÿäÿ≠ ŸÑŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿµÿ∫Ÿäÿ±ÿ© (ŸÑÿ≠ŸÑ ŸÖÿ¥ŸÉŸÑÿ© ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑŸÖÿ¥ŸàŸá)
                                                                                                                                                                                                                                                                                                                                             const MB = 1024 * 1024;
                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                             if (mimeType.startsWith('image/') && file.size < (20 * MB)) { 
                                                                                                                                                                                                                                                                                                                                                                         // ÿµŸàÿ± ÿ£ŸÇŸÑ ŸÖŸÜ 20MB ŸÜÿ≥ÿ™ÿÆÿØŸÖ sendPhoto
                                                                                                                                                                                                                                                                                                                                                                                     attachmentKeyName = 'photo';
                                                                                                                                                                                                                                                                                                                                                                                                 targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendPhoto`;
                                                                                                                                                                                                                                                                                                                                                                                                         } else if (mimeType.startsWith('video/') && file.size < (50 * MB)) { 
                                                                                                                                                                                                                                                                                                                                                                                                                     // ŸÅŸäÿØŸäŸàŸáÿßÿ™ ÿ£ŸÇŸÑ ŸÖŸÜ 50MB ŸÜÿ≥ÿ™ÿÆÿØŸÖ sendVideo
                                                                                                                                                                                                                                                                                                                                                                                                                                 attachmentKeyName = 'video';
                                                                                                                                                                                                                                                                                                                                                                                                                                             targetUploadUrl = `https://api.telegram.org/bot${BOTTOKEN}/sendVideo`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                             // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸÑŸÅ ÿ£ŸÉÿ®ÿ± ŸÖŸÜ ÿßŸÑÿ≠ÿØŸàÿØ ÿßŸÑŸÖÿ∞ŸÉŸàÿ±ÿ©ÿå ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ sendDocument ŸÑÿ∂ŸÖÿßŸÜ ÿØÿπŸÖ 2GB

                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const telegramFormData = new FormData();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                             telegramFormData.append('chat_id', CHATID);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     telegramFormData.append('caption', `Uploaded via Web App: ${file.name}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // ŸÜÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑŸÖŸÜÿßÿ≥ÿ® (document, photo, video)
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     telegramFormData.append(attachmentKeyName, file, file.name); 

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // 1. ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÖŸÑŸÅ ÿ•ŸÑŸâ Telegram 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const telegramResponse = await fetch(targetUploadUrl, { method: 'POST', body: telegramFormData });

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (!telegramResponse.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const errorText = await telegramResponse.text();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     throw new Error(`Telegram API Upload Failed (Status ${telegramResponse.status}): ${errorText}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const data = await telegramResponse.json();

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (data.ok) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         const result = data.result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const fileId = extractFileId(result);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             if (!fileId) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             throw new Error(`Telegram succeeded, but file ID extraction failed. Response structure unexpected.`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const fileName = file.name;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         JSON.stringify({
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             success: true,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 file_id: fileId, // ‚úÖ Ÿáÿ∞ÿß ŸáŸà ÿßŸÑŸÖÿπÿ±ŸÅ ÿßŸÑÿ∞Ÿä ÿ≥ŸÜÿπÿ™ŸÖÿØ ÿπŸÑŸäŸá
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     download_url: "", // üõë ŸÜÿ±ÿ≥ŸÑ ÿ±ÿßÿ®ÿ∑ ŸÅÿßÿ±ÿ∫ ŸÑÿπÿØŸÖ ÿßŸÑÿßÿπÿ™ŸÖÿßÿØ ÿπŸÑŸâ ÿßŸÑÿ≥Ÿäÿ±ŸÅÿ± ŸÅŸä ÿ®ŸÜÿßÿ° ÿßŸÑÿ±ÿßÿ®ÿ∑
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         filename: fileName,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             message: `File uploaded successfully.`
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             { status: 200, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 } else {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             throw new Error(`Telegram API Error: ${data.description || 'Unknown error'}`);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         } catch (e) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 console.error("Server Error in handleUpload (CATCH BLOCK):", e);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     JSON.stringify({ success: false, message: e.message || "An unexpected server error occurred." }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 { status: 500, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // 4. MAIN ROUTER
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             // =======================================================
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             Deno.serve(async (req) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 const url = new URL(req.url);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     const pathname = url.pathname;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if (req.method === 'OPTIONS') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return new Response(null, { status: 204, headers: corsHeaders });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if (pathname.startsWith('/upload_file') && req.method === 'POST') {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 return handleUpload(req);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             return new Response(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     JSON.stringify({ success: false, message: 'Invalid route.' }),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             { status: 404, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 });